<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bus manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="style.css">
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"/>
    <!--    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">-->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

</head>
<body>
<header>
    <h1>Bus manager</h1>
</header>

<div class="container">


    <br>
    <!--    <div class="form-group" id="global">-->
    <div id="currentStop"></div>
    <form id="userArea">
        <fieldset>
            <label for="areaSearch">Choose area:</label>
            <input list="areaSelect" id="areaSearch" name="areaSearch" autocomplete="off">
            <datalist id="areaSelect"></datalist>
            <label for="stopSearch">Choose stop:</label>
            <input list="stopSelect" id="stopSearch" name="stopSearch" autocomplete="off">
            <datalist id="stopSelect"></datalist>
        </fieldset>

        <button id="btn-send" class="btn btn-primary">Confirm</button>
        <button id="btn-reset" class="btn btn-primary" onClick="history.go(0)">New search</button>
    </form>
    <fieldset></fieldset>
    <div id="second">
        <form id="buttonForm">
        </form>

    </div>
    <br>

</div>

<script>
    const queryForm = document.getElementById("userArea");
    const buttonForm = document.getElementById("buttonForm");
    const sendQueryButton = document.getElementById("btn-send");
    const currentStop = document.getElementById("currentStop");
    const areaInput = document.getElementById("areaSearch");
    const stopInput = document.getElementById("stopSearch");
    const busInput = document.getElementById("busSearch");
    const myStop = document.getElementById("myStop");
    const second = document.getElementById("userArea");
    let busDirForward = " + forward + ";
    let busDirBack = " + back + ";
    let nearestStop;
    let busNumber;


    nearestStop = $(document).ready(function () {
        navigator.geolocation.getCurrentPosition(showLocation);

        function showLocation(position) {
            getNearestStop(position.coords.latitude, position.coords.longitude);
        }

        getAllAreas();
        getAllStopsByArea();
        getBusesList();
        getStopTimetable();

    });


    function getNearestStop(lat, long) {
        $.ajax({
            type: "GET",
            url: 'http://localhost:8080/location/' + lat + "/" + long,
            data: JSON
        }).done(function (response) {
            currentStop.innerHTML += `<h2 id= "myStop" "${response}">${response}</h2>`;

        })
    }

    function getAllAreas() {
        $.ajax({
            type: "GET",
            url: 'http://localhost:8080/area',
            data: JSON
        }).done(function (response) {
            response.forEach(op => areaSelect.innerHTML += `<option value="${op}">${op}</option>`)
        })
    }

    function getAllStopsByArea() {
        areaSearch.addEventListener("change", () => {

            const area = areaInput.value;
            $.ajax({
                type: "GET", url: 'http://localhost:8080/stop/' + area
            }).done(function (response) {
                response.forEach(op => stopSelect.innerHTML += `<option value="${op}">${op}</option>`);
            })

        })
    }

    function getBusesList() {
        sendQueryButton.addEventListener("click", (event) => {
            const area = areaInput.value;
            const stop = stopInput.value;

            event.preventDefault();
            $.ajax({
                type: "GET",
                url: 'http://localhost:8080/buses/' + area + "/" + stop,
                data: JSON
            }).done(function (response) {
                response.forEach(op => queryForm.innerHTML += `<button value="${op}"  type="click" id="${op}" onclick="getStopTimetable(this)" >${op}</button>`);
                console.log(response);
            })

            sendQueryButton.remove();
        });
    }

    function getStopTimetable(param) {
        const area = areaInput.value;
        const stop = stopInput.value;
        alert(param.id)
        const bus = param.id.value;
        console.log(bus);
        $.ajax({
            type: "GET",
            url: 'http://localhost:8080/timetable/' + area + "/" + stop + "/" + bus ,
            data: JSON
        }).done(function (response) {
            console.log(response);

        });


    }


</script>
</body>
</html>